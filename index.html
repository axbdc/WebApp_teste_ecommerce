<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Sem Marcador (WebXR)</title>
    <!-- Incluir Tailwind CSS para estilizar o botão de entrada (opcional, mas útil) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
        /* O overlay é o botão de entrada em AR */
        #ar-overlay {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            pointer-events: none; /* Permite interações dentro do overlay */
        }
        .ar-button {
            padding: 1rem 2rem;
            background-color: #3b82f6;
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            cursor: pointer;
            pointer-events: auto; /* Reativa a interação no botão */
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .ar-button:hover {
            background-color: #2563eb;
        }
    </style>

    <!-- A-Frame (versão mais recente para melhor suporte a WebXR) -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <!-- A-Frame Extras para o glTF loader e animações -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
    <!-- Manter scripts de gestos, úteis para manipular o modelo após a colocação -->
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>

    <script>
        // Componente A-Frame para gerir a colocação do modelo via Hit Test do WebXR
        AFRAME.registerComponent('ar-placement-helper', {
            init: function () {
                const sceneEl = this.el;
                const model = document.querySelector('#model-entity');
                const ring = document.querySelector('#placement-ring');

                // Garante que o modelo está invisível até ser colocado
                model.setAttribute('visible', 'false');

                // O evento 'ar-hit-test-update' é disparado pelo A-Frame no modo immersive-ar
                // com a funcionalidade 'hit-test' ativada.
                sceneEl.addEventListener('ar-hit-test-update', function (evt) {
                    if (evt.detail.successful) {
                        // Se for detetada uma superfície, move o anel de colocação para a posição detetada
                        ring.setAttribute('visible', 'true');
                        ring.object3D.position.copy(evt.detail.position);
                    } else {
                        // Se não for detetada nenhuma superfície, esconde o anel
                        ring.setAttribute('visible', 'false');
                    }
                });

                // Lógica de colocação do modelo ao tocar no ecrã (clique)
                sceneEl.addEventListener('click', function (evt) {
                    if (ring.getAttribute('visible')) {
                        const position = ring.object3D.position;

                        // Coloca o modelo na posição detetada e torna-o visível
                        model.setAttribute('position', {
                            x: position.x,
                            y: position.y, // Ajustar a posição Y para que o modelo fique no chão
                            z: position.z
                        });
                        model.setAttribute('visible', 'true');
                        
                        // Opcional: esconde o anel após a colocação
                        ring.setAttribute('visible', 'false');
                    } else {
                        // Se não houver hit-test bem-sucedido, ignora o clique ou exibe uma mensagem
                        console.log('Nenhuma superfície detetada para colocar o objeto.');
                    }
                });
            }
        });
    </script>
</head>

<body style="margin: 0; overflow: hidden;">
    <!-- Overlay para o botão de "Entrar em AR", necessário para iniciar o WebXR em navegadores -->
    <div id="ar-overlay">
        <button class="ar-button" id="ar-button">
            Iniciar RA (Apontar para o Chão)
        </button>
    </div>

    <a-scene
        vr-mode-ui="enabled: false;"
        loading-screen="enabled: false;"
        renderer="logarithmicDepthBuffer: true; antialias: true;"
        id="scene"
        embedded
        gesture-detector
        
        <!-- Configuração para WebXR Immersive AR. O 'hit-test' permite a deteção de planos -->
        webxr="requiredFeatures: hit-test, local-floor; optionalFeatures: dom-overlay; overlayElement: #ar-overlay;"

        <!-- Aplica o componente que faz o hit-testing e a colocação do modelo -->
        ar-placement-helper
    >
        <a-assets>
            <!-- Nota: Substitua 'assets/asset.glb' pelo caminho real do seu modelo -->
            <a-asset-item
                id="animated-asset"
                src="mouse.glb"
            ></a-asset-item>
        </a-assets>

        <!-- Anel de ajuda visual que se move na superfície detetada -->
        <a-ring
            id="placement-ring"
            radius="0.1"
            color="#FFFFFF"
            opacity="0.7"
            material="shader: flat; transparent: true"
            rotation="-90 0 0"
            visible="false"
        ></a-ring>

        <!-- A entidade do modelo 3D é colocada diretamente na cena, invisível inicialmente -->
        <a-entity
            id="model-entity"
            gltf-model="#animated-asset"
            scale="0.5 0.5 0.5"
            animation-mixer="clip: *; loop: repeat"
            class="clickable"
            gesture-handler
            visible="false"
        ></a-entity>

        <!-- A câmara do WebXR é gerida automaticamente, mas é bom ter uma fallback entity -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // Inicializa a funcionalidade WebXR no botão de entrada
        document.addEventListener('DOMContentLoaded', () => {
            const arButton = document.getElementById('ar-button');
            const scene = document.getElementById('scene');
            
            // Certifica-se de que o botão só funciona quando o A-Frame está pronto
            scene.addEventListener('loaded', () => {
                if (arButton) {
                    arButton.addEventListener('click', () => {
                        // O A-Frame usa o DOM Overlay para iniciar a sessão AR
                        if (scene.components.webxr.is= 'ar') {
                            scene.components.webxr.enterAR();
                        }
                    });

                    // Esconde o botão se a sessão AR já tiver sido iniciada ou se não for suportada
                    scene.addEventListener('enter-vr', (evt) => {
                        if (evt.detail.session.mode === 'immersive-ar') {
                            arButton.style.display = 'none';
                        }
                    });
                    scene.addEventListener('exit-vr', () => {
                         arButton.style.display = 'block';
                    });
                }
            });
        });
    </script>
</body>
</html>
